name: "Quality Assurance"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-docker:
    name: "ğŸ³â€‚Build Docker images"
    uses: ./.github/workflows/docker.workflow.yaml
    with:
      image-tag: ${{ github.ref_name }}

  build-npm:
    name: "ğŸ“¦â€‚Build NPM packages"
    uses: ./.github/workflows/npm.workflow.yaml
    with:
      pnpm-version: 8

  build-workspace:
    name: "ğŸ› ï¸â€‚Build workspace"
    uses: ./.github/workflows/workspace.workflow.yaml
    with:
      pnpm-version: 8
    needs:
      - build-npm

  lint:
    name: "ğŸ‘€â€‚Lint"
    uses: ./.github/workflows/lint.workflow.yaml
    with:
      pnpm-version: 8
      paths: |
        scripts
        docs
        packages/cli
        packages/core
        packages/cypress
        packages/metamask
        packages/playwright
        examples/cypress
        examples/cypress-plugin
        examples/playwright
        examples/playwright-plugin
    needs:
      - build-workspace

  test-unit:
    name: "ğŸ§ªâ€‚Unit testing"
    uses: ./.github/workflows/test-unit.workflow.yaml
    with:
      pnpm-version: 8
      paths: |
        packages/cli
    needs:
      - build-workspace

  test-integration:
    name: "ğŸ’‰â€‚Integration testing"
    uses: ./.github/workflows/test-integration.workflow.yaml
    with:
      pnpm-version: 8
      image-tag: ${{ github.ref_name }}
    needs:
      - build-docker
      - build-workspace

  cleanup:
    name: "ğŸ§¹â€‚Cleanup"
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint
      - test-unit
      - test-integration

    steps:
      - name: "Delete artifacts"
        uses: geekyeggo/delete-artifact@v2
        with:
          name: |
            npm-packages-*
            workspace-*
